#!/usr/bin/env python3

import sys
import os
from datetime import datetime

# Add the parent directory to the path to import modules
sys.path.append(os.path.dirname(os.path.dirname(__file__)))

from shared_utils.data_access import get_all_ip_addresses
from db_service.connection import get_db_connection
from calculate_security_scores import calculate_and_save_security_scores

def main():
    """
    Main function for vulnerability score calculation service
    """
    import argparse
    
    parser = argparse.ArgumentParser(description='üîê Security score calculation service for Solana validators')
    parser.add_argument('--limit', type=int, help='Limit number of IPs to calculate scores for')
    parser.add_argument('--verbose', '-v', action='store_true', help='Enable verbose output')
    parser.add_argument('--clean-old', action='store_true', default=True, 
                       help='Clean old entries before inserting new ones (default: True)')
    
    args = parser.parse_args()
    
    if args.verbose:
        print("üöÄ Starting security score calculation service")
        print("="*70)
    
    # Get all IP addresses from database
    ip_data_list = get_all_ip_addresses()
    
    if not ip_data_list:
        print("‚ùå No IP addresses found in database")
        return
    
    if args.verbose:
        print(f"üìä Found {len(ip_data_list)} validators with IP addresses")
    
    # Apply limit if specified
    if args.limit:
        ip_data_list = ip_data_list[:args.limit]
        if args.verbose:
            print(f"üî¢ Limiting score calculation to first {args.limit} validators")
    
    # Calculate and save security scores
    start_time = datetime.now()
    
    try:
        result = calculate_and_save_security_scores(
            ip_data_list=ip_data_list,
            verbose=args.verbose,
            clean_old=args.clean_old
        )
        
        end_time = datetime.now()
        total_time = end_time - start_time
        
        if result['success']:
            if args.verbose:
                print("\n" + "="*70)
                print("üîê SECURITY SCORE CALCULATION SUMMARY")
                print("="*70)
                print(f"üìä Results:")
                print(f"   ‚Ä¢ Total validators processed: {result['total_processed']}")
                print(f"   ‚Ä¢ Scores calculated: {result['scores_calculated']}")
                print(f"   ‚Ä¢ Average score: {result['average_score']:.1f}")
                print(f"   ‚Ä¢ Lowest score: {result['lowest_score']:.1f}")
                print(f"   ‚Ä¢ Highest score: {result['highest_score']:.1f}")
                print(f"‚è±Ô∏è  Total calculation time: {total_time}")
                print("="*70)
            else:
                print(f"Security score calculation complete: {result['scores_calculated']} scores calculated in {total_time}")
        else:
            print(f"‚ùå Score calculation failed: {result.get('error', 'Unknown error')}")
            
    except Exception as e:
        print(f"‚ùå Error during score calculation: {e}")
        if args.verbose:
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    main()
