# Vulnerability Score Service

This service calculates security scores for Solana validators based on their network security posture by analyzing open ports and vulnerabilities.

## Overview

The vulnerability score service reads data from two existing tables:

- `ip_open_ports` - Contains port scanning results
- `vulnerability_scans` - Contains vulnerability scanning results

It calculates a security score for each validator and stores the results in a new TimescaleDB hypertable called `security_scores`.

## Scoring Algorithm

The scoring system works as follows:

- **Base Score**: 100 points
- **Open Port Penalty**: -5 points per unique open port
- **Vulnerability Penalty**: -15 points per vulnerability
- **Minimum Score**: 0 (scores cannot go below zero)

### Formula

```
Final Score = max(0, 100 - (unique_open_ports_count √ó 5) - (vulnerabilities_count √ó 15))
```

### Examples

- **Validator with no issues**: 100 points
- **Validator with 3 open ports, no vulnerabilities**: 100 - (3 √ó 5) = 85 points
- **Validator with 2 open ports, 1 vulnerability**: 100 - (2 √ó 5) - (1 √ó 15) = 75 points
- **Validator with 10 open ports, 5 vulnerabilities**: 100 - (10 √ó 5) - (5 √ó 15) = 0 points

## Database Schema

The service creates a `security_scores` hypertable with the following structure:

```sql
CREATE TABLE security_scores (
    ip_address VARCHAR(50) NOT NULL,
    identity_key VARCHAR(44) NOT NULL,
    security_score INTEGER NOT NULL,
    open_ports_count INTEGER NOT NULL DEFAULT 0,
    vulnerabilities_count INTEGER NOT NULL DEFAULT 0,
    open_ports_penalty INTEGER NOT NULL DEFAULT 0,
    vulnerabilities_penalty INTEGER NOT NULL DEFAULT 0,
    base_score INTEGER NOT NULL DEFAULT 100,
    timestamp TIMESTAMPTZ NOT NULL
);
```

## Usage

### Command Line

```bash
# Basic usage
python3 vulnerability_score_service/main.py

# With verbose output
python3 vulnerability_score_service/main.py --verbose

# Limit to first 10 validators
python3 vulnerability_score_service/main.py --limit 10

# Don't clean old entries
python3 vulnerability_score_service/main.py --no-clean-old
```

### Using Shell Script

```bash
# Run the service
./scripts/services/vulnerability_score.sh

# With environment variables
VERBOSE=true LIMIT=50 ./scripts/services/vulnerability_score.sh
```

### Available Options

- `--limit N`: Limit calculation to first N validators
- `--verbose`: Enable detailed output
- `--clean-old`: Clean old entries before inserting new ones (default: true)

## Data Flow

1. **Retrieve Validators**: Gets all IP addresses and identity keys from the gossip peers table
2. **Get Latest Ports**: For each validator, retrieves the most recent port scan results
3. **Get Latest Vulnerabilities**: For each validator, retrieves the most recent vulnerability scan results
4. **Calculate Score**: Applies the scoring algorithm
5. **Store Results**: Saves scores to the `security_scores` hypertable
6. **Use Timestamp**: Uses the timestamp from the port scan data to maintain consistency

## Key Features

- **TimescaleDB Integration**: Creates a hypertable for efficient time-series storage
- **Latest Data Only**: Always uses the most recent scan results for calculations
- **Timestamp Consistency**: Uses port scan timestamps to maintain data integrity
- **Duplicate Prevention**: Cleans old entries before inserting new ones (optional)
- **Comprehensive Tracking**: Stores both the final score and the breakdown of penalties

## Dependencies

- PostgreSQL with TimescaleDB extension
- Python 3.x
- psycopg2
- Access to existing `ip_open_ports` and `vulnerability_scans` tables

## Files

- `main.py`: Main entry point and command-line interface
- `calculate_security_scores.py`: Core scoring logic and database operations
- `save_scores_to_db.py`: Database utility functions for saving scores
- `__init__.py`: Package initialization
- `../scripts/services/vulnerability_score.sh`: Shell script wrapper

## Error Handling

The service includes comprehensive error handling:

- Database connection failures
- Missing tables (automatically creates them)
- Invalid data handling
- Transaction rollback on errors
- Graceful degradation when TimescaleDB features aren't available

## Monitoring

The service provides detailed logging and progress tracking:

- Connection status
- Processing progress
- Score calculation details
- Database operation results
- Summary statistics (average, min, max scores)

## Example Output

```
üöÄ Starting security score calculation service
=============================================
üìä Found 150 validators with IP addresses
üî¢ Limiting score calculation to first 10 validators
üì° Connecting to database...
üîç Processing 192.168.1.100 (Identity: AbCdEfGh...)
   üìä Score: 85/100 (Ports: 3, Vulns: 0)
üîç Processing 192.168.1.101 (Identity: XyZwVuTs...)
   üìä Score: 70/100 (Ports: 2, Vulns: 1)
...
üíæ Saving 10 security scores...
=============================================
üîê SECURITY SCORE CALCULATION SUMMARY
=============================================
üìä Results:
   ‚Ä¢ Total validators processed: 10
   ‚Ä¢ Scores calculated: 10
   ‚Ä¢ Average score: 78.5
   ‚Ä¢ Lowest score: 45.0
   ‚Ä¢ Highest score: 100.0
‚è±Ô∏è  Total calculation time: 0:00:05.234567
=============================================
```
