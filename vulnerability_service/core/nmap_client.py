#!/usr/bin/env python3

import nmap3
import threading

# Thread-local storage for nmap instances
thread_local = threading.local()

def get_nmap():
    """Get thread-local nmap instance"""
    if not hasattr(thread_local, 'nmap'):
        thread_local.nmap = nmap3.Nmap()
    return thread_local.nmap

def run_nmap_scan(ip_address, nmap_args, verbose=False):
    """
    Run nmap scan with given arguments
    
    Args:
        ip_address (str): Target IP address
        nmap_args (str): Nmap command arguments
        verbose (bool): Enable verbose output
        
    Returns:
        XML Element: Raw nmap XML results
    """
    nmap = get_nmap()
    thread_name = threading.current_thread().name
    
    if verbose:
        print(f"[{thread_name}] Running nmap scan on {ip_address} with args: {nmap_args}")
    
    return nmap.scan_command(target=ip_address, arg=nmap_args) 